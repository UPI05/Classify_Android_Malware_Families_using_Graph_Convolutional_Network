from androguard.misc import AnalyzeAPK
import os
import json
import logging


def append_to_file(file_path, content):
    with open(file_path, 'a') as file:
        file.write(str(content) + "\n")  # Thêm nội dung vào cuối file và xuống dòng

def get_package_name(apk_path):
    a, d, dx = AnalyzeAPK(apk_path)
    # Lấy package name trực tiếp từ đối tượng APK
    package_name = a.get_package()
    return package_name

def analyze_apk(apk_path):
    package_name = get_package_name(apk_path)
    a, d, dx = AnalyzeAPK(apk_path)
    analysis_result = {"apk": apk_path, "developer_defined_classes": []}

    # Duyệt qua các class và chỉ xử lý các class thuộc package_name chỉ định
    for cls in dx.get_classes():
        if ("L" + package_name.replace('.', '/')) in cls.name:
            class_info = {"class_name": cls.name, "methods": []}
            for method in cls.get_methods():
                method_info = {"method_name": method.name, "api_calls": []}
                for _, call, _ in method.get_xref_to():
                    call_info = {"class": call.class_name, "method": call.name}
                    method_info["api_calls"].append(call_info)
                # Chỉ thêm method_info vào class_info nếu có nhiều hơn một API call
                if len(method_info["api_calls"]) > 1:
                    class_info["methods"].append(method_info)
            # Thêm class_info vào kết quả nếu có các method hợp lệ
            if len(class_info['methods']) > 0:
                analysis_result["developer_defined_classes"].append(class_info)
    return analysis_result


def main(folder_path, output_json_path):

    all_analysis_results = []
    for root, dirs, files in os.walk(folder_path):
        for file in files:
            if file.endswith(".apk"):
                apk_path = os.path.join(root, file)
                analysis_result = analyze_apk(apk_path)

                all_analysis_results.append(analysis_result)
    
    with open(output_json_path, 'w') as f:
        json.dump(all_analysis_results, f, indent=4)

if __name__ == "__main__":
    folder_path = './dataset'  # Thay đổi đường dẫn tới folder chứa các subfolders
    output_json_path = 'extracted_co_occurrent_apis_with_androguard.json'  # Đường dẫn file JSON để lưu kết quả
    main(folder_path, output_json_path)
